# Fabric Network: Runtime Architecture

## Content

[TOC]

再学习下面的内容之前，我想说一下自己关于 Fabric 框架学习的一些建议。

Fabric 网络是整个 Fabric 中最核心、最重要，最关键的部分，也是学习 Fabric 框架的第一道拦路虎，同时也是最难啃的一块骨头。

可以这样说，彻底搞懂 Fabric 网络，那之后的合约开发和应用开发简直就像喝水一样简单。

但是，彻底搞懂谈何容易，本部分内容不仅十分冗杂，且难度颇高，其涉及到的核心原理即扩展技术想要彻底弄明白需要下很大的功夫，如对于原理部分的排序策略和交易和区块传播中涉及到各种协议；再如对于技术部分的 CA、各种策略配置、集群、数据库等。

所以，对于 Fabric 框架学习，我本人有三个原则：

1. 思路清晰。在学习时一定要在通篇浏览的基础上，构建自己的学习路线，拥有一个清晰的学习思路。本部分的内容，我打算拆分成两部分，一是网络的架构介绍，阐述网络中的各种角色及角色之间的关系，二是网络中交易流程的详细介绍，说明各种角色在一次交易流程中所要承担的各种职责，及每种职责触发的各种事件。即整体的学习路线为：

   【图：架构—>角色—>角色间的关系—>角色承担的职责—>承担职责时触发的事件。】

2. 懂得取舍。由于内容繁杂丰富，所以初始阶段不太深究那些过于详实的内容，如协议、算法的细节，配置文件的详细字段含义等。

3. 优先实践。再难的框架，用它手动编写一个应用后，都可以学会个大概。

## Architecture Overview

![Structure](res\【2020.12.26】Fabric Network Runtime Architecture\Structure.png)

图中展示了 *Fabric* 的网络架构，整个网络大致上划分成了两个区域，对等网络区域和用户客户端区域。网络中包括了四种角色，分别为：**对等节点**、**排序节点**、**认证代理**和**客户端**。这些都是具体的实体。

**对等节点**是账本和链码的载体，负责向客户端应用发出事件。它存在着四种类型，分别为：提交节点、背书节点、锚节点和主节点。不同类型的节点，其提供的功能，或是称之为其承担的职责，是会有交叉的，如提交节点和背书节点都承担着存储区块链副本、世界状态数据库等职责。关于对等节点的详细结构与各种类型节点之间的联系和区别，后面会做具体介绍。

**排序节点**承担着依照排序策略对交易进行排序、打包、分发的工作。对等网络中的排序节点（无论这些排序阶段是否同属于一个通道），往往会通过建立排序节点集群来对其统一集中管理。

**CA** 是 *Fabric* 网络中的证书机构，它承担了所有涉及到身份注册、认证和管理等与证书相关的操作。它采取了 *C/S* 架构，为了扩展性，**CA 服务端**可分为**根 CA 服务端**和**多级中间 CA 服务端**。类似于排序节点，CA 中间服务端也大多采用集群来管理，而且，为了满足高并发的要求，集群还会采取添加 **HA 代理**的方式来做负载均衡，证书被统一存储在集群中的**证书数据库**中。

**客户端**的第一个身份是**应用客户端**，它是 *Fabric* 网络服务的使用者，其通过 *Fabric* 提供的 **SDK** 编写应用或是直接通过 **Fabric Cli** 来向 *Fabric* 网络发起各种交易请求。它的另一个身份是 **CA 客户端**，在访问 *Fabric* 网络服务前需要通过中间 CA 服务端的认证接入网络。

其实这些实体之间还存在着一些复杂的关系，这些关系主要包括如下三种：**通道**、**组织**和**集群**。通常情况下，一个通道中包含着多个组织，每个组织内存在着一定数目的对等节点、排序节点、CA 和客户端，而集群往往是脱离前两者来说的，集群是为了便于技术人员对网络进行管理而引入的一种额外的关系，也就是说，*Fabric* 网络中可以没有集群

但是这三者的关系又不仅仅如此简单，三者之间彼此之间都具有交叉的部分，后面会做详细阐述。

## Roles

#### Peer

- Committer：提交节点，还称为记账节点。负责执行链码（如果部署了的话），存储账本，并对收到的区块验证有效后存储到账本。

- Endorser：背书节点。具备提交节点的功能，不同的是，首先背书节点上一定已经部署了链码，且其可以接受客户端应用发来的交易提案，并模拟交易，最后向客户端返回模拟交易的链码调用执行结果。

- Anchor：锚节点。具备提交节点的功能，负责向外部（指的是本通道内其它组织中的节点）提供本组织内其它节点的发现服务。

- Leader：具备提交节点的功能，与排序节点相连接，负责接收来自排序节点的交易并广播给本组织内的其它节点。

- Endorser Proxy：背书节点上每个链码在实例化时可以指定一个背书策略来引用一组背书节点，即这个链码仅会在这些被指定的节点上部署。客户端在发起交易提案时会根据待调用链码的背书策略，将交易提案发给对应的背书节点。背书节点再根据提案中的链码调用请求对链码执行相应的调用，向客户端返回其签名和背书结果等信息，但是此时不写入执行结果。客户端根据收到各背书节点的签名、背书结果后，验证签名和背书结果是否满足背书策略等。

  上面只是背书节点和链码级背书策略在整个交易流程中经历的部分，对于完整的交易流程会在 *Fabric* 网络第二节的*交易流程*中详细介绍。

  另外也可以在通道实例化或者升级对应链码时设置背书策略，这个过程称为设置键级别的背书策略，不过目前还用不着深入了解。

  背书策略的通用形式为：

  ***`P = {AND(P1, P2, P3), OR(P1, P2, P3), OutOf(m, P1, P2, .., Pi, .., Pn), m <= n}`***

  `Pi` 指的是策略, 由最基本的三种策略组成。所以 `P` 是可以嵌套的。

  注意 `OR` 策略要慎重选择，有一节点作恶就会导致严重后果。

  对于 `OutOf`，`m` 指的是需要节点签名背书的数量，即 `n` 个背书节点至少需要 `m` 个节点的签名背书。

- 链码：这里只是简要的阐述一下链码生命周期涉及到的一些内容，详细的会在链码开发那部分介绍。在之前的 *Overview* 中，已经说明了链码要经历生命周期的四个阶段，这里只做简单阐述。

  【】

- 账本

  

#### Orderer

【】

#### CA

【】

#### Client

【】

## Relationships

#### Channel

【】

![Channel](res/【2020.12.26】Fabric Network Runtime Architecture/Channel.png)

【】

#### Organization

【】

#### Cluster

【】

![Venn](res/【2020.12.26】Fabric Network Runtime Architecture/Venn.png)

【】

## Conclusion

【】