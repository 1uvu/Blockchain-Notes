新发布的区块和交易是如何在比特币网络上传播的？

### 比特币网络传播原理

比特币工作在应用层（Application layer），在应用层运行比特币协议。

在网络层（Network layer）运行 P2P Overlay Network。

比特币的 P2P 网络很简单，所有节点都是对等节点，不像一些其他的 P2P 网络存在着超级节点（Super node）或主节点（Master node）

如果你想要加入一个比特币网络，至少需要知道一个种子节点（seed node），和这个种子节点通过 TCP 联系，种子告诉你它所知道的节点。

如果你想要离开一个网络，直接离开即可，其他节点一段时间收不到你的消息，会直接删掉你。

比特币网络设计的原则是：简单、鲁棒，而不是高效。

每个节点维护一个其邻居节点的集合，网络中的消息传播采取泛洪（Flooding）的方式。

具体的传播细节是这样的：节点新收到某条消息是，将其泛洪到全部邻居节点，同时将此消息设置为已收到，因此下次收到相同的消息就不再泛洪。

至于邻居节点，与路由中有所不同，为了鲁棒性，邻居的选择不是按照网络拓扑进行的，而是随机选取的，谁是节点的邻居由节点自行选择，这样的方式牺牲了效率。

比特币系统中每个节点都需要维护一个等待上链的交易的集合，当一条交易写入区块链时，删除这一条交易。

当新收到一条交易消息时，将其存入这个集合，并泛洪，之后再收到相同交易就不用管了。

当交易消息发送冲突时，即同一个节点向不同节点转账的交易信息同时传播到网络上（A->B 和 A->C），有部分节点先收到了第一条，部分节点先收到第二条。

这时候，假如先收到第一条消息的节点收到了第二条，这时就发生了冲突（双花攻击，因为对于没有写入区块链的交易，节点无法确定两次交易的转走的币的来源是否一样，来源一样时就是双花攻击，所以会冲突）。

假如只收到第一条交易消息的节点得知了第二条交易已经写入区块链，那么也会将第一条从集合中移除，反之亦然。

另外，由于比特币网络的低效率，尤其是泛洪的方案对于带宽的限制，比特币规定了每个区块最大为 1MBytes，且消息的传播采取了 best-effect 的策略。

