## 比特币的共识协议

普通的中心化基于公私钥的数字货币

存在：花两次攻击（double spending attack ）。

解决，加上编号。但是由于是中心化的，太麻烦了。

去中心化的数字货币需要解决两个问题：

### 1  谁来发行？什么时候发行？发行多少？

下文会一一解答。

### 2  验证交易的有效性，防范花两次攻击

比特币每个系统都需要包括输入输出两部分。

输入部分说明（通过哈希指针指向，这里的哈希指针，也就是来源，可以有多个）币的来源，输出部分给出（同样是指针）收款人的公钥的哈希。

比特币中收款人的地址是通过收款人的公钥推算的。

但是比特币系统没有提供查询特定人公钥的方式，需要收款人自己公布。

值得注意的是，为了验证交易的合法性，发款人的公钥需要被收款人知道，也就是要验证交易签名的有效性。

而且，区块链中的全部其他节点同样需要知道发款人的公钥，这是为了有恶意者声称自己的公钥是发款人的，再使用自己的私钥对交易签名，这样发款人即使没有发款，币也被转走了。

因此，可通过检测输入来源的哈希与声称的公钥的哈希是否一致来防范上述的漏洞。

在比特币中是通过将当前交易的输入脚本（Bitcoin Script）与前一个交易的输出脚本合在一起运行，如果无误则是正确的。



其实，一个区块中可以保存有多个交易，被组织成 Merkle tree。

区块分为块头（block header）和块身（block body）两部分

1. 块头

   - version

   - hash of previous block header
   - Merkle root hash
   - target：挖坑的难度目标阈值，存的是目标阈值的编码，称为 nBits
   - nonce：随机数

2. 块身

   - transaction list：交易列表

对区块取哈希一般只取块头，因为 Merkle root hash 已经保证了交易没有被篡改。

在构造区块链的时候，账本的内容应该取得分布式共识（distributed consensus）。

以分布式哈希表（distributed hash table）为例，对于分布式系统，比较著名的理论有：

1. FLP impossibility result

   在一个异步系统（asynchronous system）中，如果网络传输的时延没有上限，则即使只有一个成员有问题，那也不可能取得共识。

2. CAP theorem

   分布式系统的三个性质：一致性（Consistency）、可用性（Availability）、分区容错性（Partition tolerance）

   上述三个性质最多同时满足两个。

   Paxos 是用于保证分布式系统一致性的协议。

比特币共识需要解决的一个问题是，可能存在恶意节点，因此可以假设大多数是好的。

一种方案是基于投票的方式，但是确定哪些节点具有投票权很重要，在联盟链（hyperledger fabric）中这个方案是可行的，但是比特币属于公有链，假设一个超级计算机不停地产生新账户，超过半数时对投票结果就有了控制权，称为女巫攻击（sybil attack），此方案不可行。

比特币中采取了基于算力的投票方案：

H(block header) <= target，nonce(4bytes)，当一台机器找到了 nonce，那么它就获得记账权（写入下一个区块，可以发布一个区块）

当发布区块时有一些问题值得注意：

1. 区块根据哈希指针可以知道自己应该插到哪里
2. 当插入的区块不在最长合法链（longest vaild chain）时，这属于分叉攻击（forking attack），此时不接受这个区块
3. 当两个节点同时找到 nonce ，同时写入新区块时也会产生临时性的分叉，此分叉会维持一段时间，当某一个叉率先找到下一个区块时则胜出，变成最长合法链，另一个叉被丢弃，称为孤块（orphan block）

为什么要通过挖坑争夺记账权呢？

出块奖励（block reward），比特币规定，获得记账权的节点在发布区块时可以进行铸币交易，发布一定数量（随着块的数量越来越多，数量减一番）的比特币，这就回答了谁来发布货币的问题。

总而言之，比特币中的共识指的是分布式账本中的内容，只有获取记账权的节点才可以写入账本内容，只有通过 puzzle，即挖矿（mining）游戏 才可以获取记账权，挖坑的人称为矿工（miner）